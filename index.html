<script type="module">
    // Import Firebase functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDW2EoCzZpPLKFaD8C2TT3tZSwnX9VZq_I",
        authDomain: "nothing-website-ed54b.firebaseapp.com",
        projectId: "nothing-website-ed54b",
        storageBucket: "nothing-website-ed54b.firebasestorage.app",
        messagingSenderId: "283652562330",
        appId: "1:283652562330:web:2a9e274f58c53946116e23",
        measurementId: "G-291R18LRME"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM Elements
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const showRegister = document.getElementById('show-register');
    const showLogin = document.getElementById('show-login');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const authContainer = document.getElementById('auth-container');
    const mainContent = document.getElementById('main-content');
    const welcomeMessage = document.getElementById('welcome-message');
    const logoutBtn = document.getElementById('logout-btn');

    // Form Toggle
    showRegister.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
    });

    showLogin.addEventListener('click', (e) => {
        e.preventDefault();
        registerForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
    });

    // Register Function
    registerBtn.addEventListener('click', async () => {
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const username = document.getElementById('register-username').value;

        if (!email || !password || !username) {
            showMessage('Please fill in all fields', 'error');
            return;
        }

        try {
            // Check if username already exists
            const usernameQuery = query(collection(db, 'users'), where('username', '==', username));
            const usernameSnapshot = await getDocs(usernameQuery);
            
            if (!usernameSnapshot.empty) {
                showMessage('Username already taken', 'error');
                return;
            }

            // Check if email already exists
            const emailQuery = query(collection(db, 'users'), where('email', '==', email));
            const emailSnapshot = await getDocs(emailQuery);
            
            if (!emailSnapshot.empty) {
                showMessage('Email already registered', 'error');
                return;
            }

            // Create user with Firebase Auth
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // Save user data to Firestore
            await addDoc(collection(db, 'users'), {
                uid: user.uid,
                username: username,
                email: email,
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                password: password // Still storing plain text as requested
            });

            showMessage('Registration successful!', 'success');
            
            // Switch to login form
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            
            // Clear form
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-username').value = '';

            console.log('User registered:', { uid: user.uid, email, username });

        } catch (error) {
            console.error('Registration error:', error);
            showMessage(error.message, 'error');
        }
    });

    // Login Function
    loginBtn.addEventListener('click', async () => {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if (!email || !password) {
            showMessage('Please fill in all fields', 'error');
            return;
        }

        try {
            // Authenticate with Firebase Auth (this checks email and password)
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // Get user data from Firestore
            const usersQuery = query(collection(db, 'users'), where('uid', '==', user.uid));
            const querySnapshot = await getDocs(usersQuery);
            
            let username = 'User';
            let userDocId = null;
            
            if (!querySnapshot.empty) {
                const userDoc = querySnapshot.docs[0];
                userDocId = userDoc.id;
                const userData = userDoc.data();
                username = userData.username;
                
                // Update last login
                await updateDoc(doc(db, 'users', userDocId), {
                    lastLogin: new Date().toISOString()
                });
            }

            showMessage('Login successful!', 'success');
            welcomeMessage.textContent = `Welcome, ${username}!`;
            
            // Show main content
            authContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');

            console.log('User logged in:', { uid: user.uid, email, username });

        } catch (error) {
            console.error('Login error:', error);
            showMessage(error.message, 'error');
        }
    });

    // Logout Function
    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            showMessage('Logged out successfully', 'success');
            authContainer.classList.remove('hidden');
            mainContent.classList.add('hidden');
            
            // Clear form fields
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-username').value = '';

        } catch (error) {
            console.error('Logout error:', error);
            showMessage(error.message, 'error');
        }
    });

    // Auth State Listener
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User is signed in
            const usersQuery = query(collection(db, 'users'), where('uid', '==', user.uid));
            const querySnapshot = await getDocs(usersQuery);
            
            let username = 'User';
            if (!querySnapshot.empty) {
                const userData = querySnapshot.docs[0].data();
                username = userData.username;
            }

            welcomeMessage.textContent = `Welcome, ${username}!`;
            authContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
        } else {
            // User is signed out
            authContainer.classList.remove('hidden');
            mainContent.classList.add('hidden');
        }
    });

    // Show Message Function
    function showMessage(message, type) {
        const toast = document.getElementById('message-toast');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');

        toastMessage.textContent = message;
        
        if (type === 'success') {
            toast.style.borderLeftColor = '#10B981';
            toastIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
        } else {
            toast.style.borderLeftColor = '#EF4444';
            toastIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
        }

        toast.classList.remove('hidden');
        
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 5000);
    }

    // Minigames functionality
    
    // Color Changer Game
    const colorBox = document.getElementById('color-box');
    const colorReset = document.getElementById('color-reset');
    
    colorBox.addEventListener('click', () => {
        const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
        colorBox.style.background = randomColor;
    });
    
    colorReset.addEventListener('click', () => {
        colorBox.style.background = '#06b6d4'; // cyan-500
    });

    // Clicker Game
    const clickerButton = document.getElementById('clicker-button');
    const clickerStart = document.getElementById('clicker-start');
    const clickerTimer = document.getElementById('clicker-timer');
    
    let clickCount = 0;
    let gameActive = false;
    let timeLeft = 10;
    
    clickerStart.addEventListener('click', () => {
        if (gameActive) return;
        
        clickCount = 0;
        gameActive = true;
        timeLeft = 10;
        clickerButton.textContent = clickCount;
        clickerTimer.textContent = `Time: ${timeLeft}s`;
        clickerStart.disabled = true;
        clickerStart.textContent = 'Playing...';
        
        const gameInterval = setInterval(() => {
            timeLeft--;
            clickerTimer.textContent = `Time: ${timeLeft}s`;
            
            if (timeLeft <= 0) {
                clearInterval(gameInterval);
                gameActive = false;
                clickerStart.disabled = false;
                clickerStart.textContent = 'Start Game';
                clickerTimer.textContent = `Game Over! Score: ${clickCount}`;
                
                // Save score to Firestore if user is logged in
                if (auth.currentUser) {
                    saveGameScore('clicker', clickCount);
                }
            }
        }, 1000);
    });
    
    clickerButton.addEventListener('click', () => {
        if (gameActive) {
            clickCount++;
            clickerButton.textContent = clickCount;
        }
    });

    // Memory Game
    const memoryGame = document.getElementById('memory-game');
    const memoryReset = document.getElementById('memory-reset');
    
    const memoryCards = ['A', 'A', 'B', 'B', 'C', 'C', 'D', 'D', 'E', 'E'];
    let flippedCards = [];
    let matchedPairs = 0;
    let memoryMoves = 0;
    
    function initializeMemoryGame() {
        memoryGame.innerHTML = '';
        flippedCards = [];
        matchedPairs = 0;
        memoryMoves = 0;
        
        const shuffledCards = [...memoryCards].sort(() => Math.random() - 0.5);
        
        shuffledCards.forEach((card, index) => {
            const cardElement = document.createElement('div');
            cardElement.className = 'memory-card bg-cyan-500 rounded-lg flex items-center justify-center text-white font-bold cursor-pointer transition-all duration-300 hover:bg-cyan-600 h-16';
            cardElement.textContent = '?';
            cardElement.dataset.value = card;
            cardElement.dataset.index = index;
            
            cardElement.addEventListener('click', () => flipCard(cardElement));
            
            memoryGame.appendChild(cardElement);
        });
    }
    
    function flipCard(card) {
        if (flippedCards.length < 2 && !card.classList.contains('flipped') && !card.classList.contains('matched')) {
            card.classList.add('flipped', 'bg-pink-500');
            card.textContent = card.dataset.value;
            flippedCards.push(card);
            memoryMoves++;
            
            if (flippedCards.length === 2) {
                checkForMatch();
            }
        }
    }
    
    function checkForMatch() {
        const [card1, card2] = flippedCards;
        
        if (card1.dataset.value === card2.dataset.value) {
            card1.classList.add('matched', 'bg-green-500');
            card2.classList.add('matched', 'bg-green-500');
            matchedPairs++;
            
            if (matchedPairs === memoryCards.length / 2) {
                setTimeout(() => {
                    showMessage(`Congratulations! You won in ${memoryMoves} moves!`, 'success');
                    // Save score to Firestore if user is logged in
                    if (auth.currentUser) {
                        saveGameScore('memory', memoryMoves);
                    }
                }, 500);
            }
            
            flippedCards = [];
        } else {
            setTimeout(() => {
                card1.classList.remove('flipped', 'bg-pink-500');
                card2.classList.remove('flipped', 'bg-pink-500');
                card1.textContent = '?';
                card2.textContent = '?';
                card1.classList.add('bg-cyan-500');
                card2.classList.add('bg-cyan-500');
                flippedCards = [];
            }, 1000);
        }
    }
    
    memoryReset.addEventListener('click', initializeMemoryGame);
    initializeMemoryGame();

    // Save game score to Firestore
    async function saveGameScore(gameType, score) {
        try {
            await addDoc(collection(db, 'gameScores'), {
                uid: auth.currentUser.uid,
                gameType: gameType,
                score: score,
                timestamp: new Date().toISOString()
            });
            console.log(`Saved ${gameType} score: ${score}`);
        } catch (error) {
            console.error('Error saving game score:', error);
        }
    }

    // Export Firebase instances to global scope for console access
    window.firebaseApp = app;
    window.firestoreDb = db;
    window.firebaseAuth = auth;
    window.firebaseAnalytics = analytics;

    // Console helper functions
    window.viewAllUsers = async function() {
        const querySnapshot = await getDocs(collection(db, 'users'));
        console.log('=== ALL USERS ===');
        querySnapshot.forEach((doc) => {
            console.log('User ID:', doc.id, 'Data:', doc.data());
        });
    };

    window.viewGameScores = async function() {
        const querySnapshot = await getDocs(collection(db, 'gameScores'));
        console.log('=== GAME SCORES ===');
        querySnapshot.forEach((doc) => {
            console.log('Score ID:', doc.id, 'Data:', doc.data());
        });
    };

    console.log('Firebase initialized! Use these commands in console:');
    console.log('viewAllUsers() - View all registered users');
    console.log('viewGameScores() - View all game scores');
    console.log('firestoreDb - Access Firestore database');
    console.log('firebaseAuth - Access Auth instance');
</script>
